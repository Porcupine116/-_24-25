{% extends "base.html" %}

{% block title %}Панель студента{% endblock %}

{% block content %}
<div class="student-dashboard">
    <div class="dashboard-container">
        <h1 class="welcome-title">
            Добро пожаловать, {{ current_user.name }} {{ current_user.last_name }}!
        </h1>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="flashes">
                    {% for message in messages %}
                        <div class="flash">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Progress Block -->
        <div class="student-progress-block">
            <div class="metric">
                <span class="metric-label">Всего заданий</span>
                <span class="metric-value">{{ assignments|length }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">Сдано</span>
                <span class="metric-value">
                    {% set submitted = 0 %}
                    {% for assignment in assignments %}
                        {% set my_submission = assignment.submissions | first %}
                        {% if my_submission and my_submission.score is not none %}
                            {% set submitted = submitted + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ submitted }}
                </span>
            </div>
            <div class="metric">
                <span class="metric-label">Средний балл</span>
                <span class="metric-value">
                    {% set all_scores = [] %}
                    {% for sub in submissions %}
                        {% if sub.score is not none %}
                            {% set _ = all_scores.append(sub.score) %}
                        {% endif %}
                    {% endfor %}
                    {% if all_scores %}
                        {{ (all_scores | sum) // (all_scores | length) }}
                    {% else %}
                        —
                    {% endif %}
                </span>
            </div>
        </div>

        <div class="assignments-section">
            <h2 class="section-title">Мои задания</h2>
            <div class="assignments-grid">
                {% for assignment in assignments %}
                {% set my_submission = assignment.submissions | selectattr('student_id', 'equalto', current_user.id) | first %}
                <div class="assignment-card">
                    <div class="assignment-header">
                        <h3>{{ assignment.title }}</h3>
                        {% if my_submission and my_submission.score is not none %}
                            <span class="score-label">
                                {{ my_submission.score }}/{{ assignment.max_score }}
                            </span>
                        {% endif %}
                    </div>
                    <span class="due-date">
                        {% if assignment.deadline %}
                            Срок сдачи: {{ assignment.deadline.strftime('%d.%m.%Y') }}
                        {% else %}
                            Без срока
                        {% endif %}
                    </span>
                    <p class="assignment-description">{{ assignment.description }}</p>
                    <div class="assignment-status">
                        {% if my_submission %}
                            {% if my_submission.score is not none %}
                                <div class="score submitted">
                                    <i class="fa fa-check-circle"></i> Сдано
                                </div>
                                <a href="{{ url_for('main.submit_assignment', assignment_id=assignment.id) }}"
                                   class="btn btn-small">Изменить решение</a>
                            {% else %}
                                <div class="score waiting">
                                    <i class="fa fa-hourglass-half"></i> Сдано, ожидает проверки
                                </div>
                                <a href="{{ url_for('main.submit_assignment', assignment_id=assignment.id) }}"
                                   class="btn btn-small">Изменить решение</a>
                            {% endif %}
                        {% else %}
                            <div class="score not-submitted">
                                <i class="fa fa-times-circle"></i> Не сдано
                            </div>
                            <a href="{{ url_for('main.submit_assignment', assignment_id=assignment.id) }}"
                               class="btn btn-small btn-primary">Сдать работу</a>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="no-assignments">
                    <p>На данный момент у вас нет активных заданий</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
